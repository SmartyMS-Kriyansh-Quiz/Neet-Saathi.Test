<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BIOLOGY DPP-02</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; }
    header { background:#222; color:#fff; padding:15px; text-align:center; }
    .info-box { text-align:center; margin:10px 0; }
    .marking-box { text-align:center; background:#fff3cd; color:#000; padding:10px; border-radius:8px; margin-bottom:20px; }
    .container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
    .btn { padding:10px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin:10px; }
    .btn-start { background:#28a745; color:#fff; }
    .btn-submit { background:#007bff; color:#fff; display:none; }
    .btn-leaderboard { background:#17a2b8; color:#fff; display:none; }
    .btn-close { background:#dc3545; color:#fff; display:none; }
    .entry input { width:100%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #ccc; }
    .entry button { width:100%; }
    .question img { width:100%; border:1px solid #ccc; margin-bottom:10px; }
    .options label { display:block; margin:5px 0; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>BIOLOGY DPP-02</h1>
    <div class="info-box"><b>Total Questions: 20</b></div>
    <div class="marking-box">
      ✔ If Correct: +4 Marks &nbsp; ❌ If Wrong: –1 Mark
    </div>
  </header>

  <div class="container">
    <div id="entrySection" class="entry">
      <input type="text" id="nameInput" placeholder="Enter Your Name">
      <input type="date" id="dobInput" placeholder="Enter Your DOB">
      <button id="saveStartBtn" class="btn btn-start">Save & Start</button>
    </div>

    <div id="quizSection" style="display:none;">
      <div id="questionArea" class="question"></div>
      <button id="prevBtn" class="btn">Previous</button>
      <button id="nextBtn" class="btn">Next</button>
      <button id="submitBtn" class="btn btn-submit">Submit Test</button>
      <button id="leaderboardBtn" class="btn btn-leaderboard">View Leaderboard</button>
      <button id="closeBtn" class="btn btn-close">Close Test</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    const nameInput = document.getElementById("nameInput");
    const dobInput = document.getElementById("dobInput");
    const saveStartBtn = document.getElementById("saveStartBtn");
    const quizSection = document.getElementById("quizSection");
    const entrySection = document.getElementById("entrySection");
    const questionArea = document.getElementById("questionArea");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const closeBtn = document.getElementById("closeBtn");

    let questions = [];
    let currentQ = 0;
    let userAnswers = {};
    let answerKey = {};

    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";

    async function loadAnswers() {
      const pdf = await pdfjsLib.getDocument("test.pdf").promise;
      const lastPage = await pdf.getPage(pdf.numPages);
      const txtContent = await lastPage.getTextContent();
      const txt = txtContent.items.map(i => i.str).join(" ");
      const matches = [...txt.matchAll(/Ans\.\s*([A-D])/gi)];
      matches.forEach((m, idx) => {
        answerKey[idx+1] = m[1].toUpperCase();
      });
      localStorage.setItem("answerKey", JSON.stringify(answerKey));
    }

    async function loadQuestions() {
      const pdf = await pdfjsLib.getDocument("test.pdf").promise;
      const total = pdf.numPages;
      for (let i = 1; i < total; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({scale:1.2});
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({canvasContext: ctx, viewport}).promise;
        const img = canvas.toDataURL("image/png");
        questions.push(img);
      }
    }

    saveStartBtn.addEventListener("click", async () => {
      if (!nameInput.value.trim() || !dobInput.value.trim()) {
        alert("Enter all details!");
        return;
      }
      localStorage.setItem("userName", nameInput.value.trim());
      localStorage.setItem("userDob", dobInput.value.trim());
      entrySection.style.display = "none";
      quizSection.style.display = "block";
      submitBtn.style.display = "block";
      await loadAnswers();
      await loadQuestions();
      showQuestion(0);
    });

    function showQuestion(i) {
      currentQ = i;
      questionArea.innerHTML = `
        <img src="${questions[i]}" alt="Question ${i+1}">
        ${["A","B","C","D"].map(opt =>
          `<label><input type="radio" name="q${i}" value="${opt}" ${userAnswers[i]==opt?'checked':''}> Option ${opt}</label>`).join("")}
      `;
    }

    prevBtn.addEventListener("click", () => {
      if (currentQ > 0) {
        saveAnswer();
        showQuestion(currentQ - 1);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentQ < questions.length - 1) {
        saveAnswer();
        showQuestion(currentQ + 1);
      }
    });

    function saveAnswer() {
      const radios = document.getElementsByName(`q${currentQ}`);
      for (let r of radios) {
        if (r.checked) {
          userAnswers[currentQ] = r.value;
          break;
        }
      }
    }

    submitBtn.addEventListener("click", () => {
      saveAnswer();
      let correct = 0;
      Object.keys(userAnswers).forEach(i => {
        const qNum = parseInt(i) + 1;
        if (userAnswers[i] === answerKey[qNum]) correct++;
      });
      const wrong = Object.keys(userAnswers).length - correct;
      const unattempted = questions.length - Object.keys(userAnswers).length;
      const marks = correct * 4 - wrong;
      const percentage = Math.round((marks / (questions.length * 4)) * 100);

      let leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");
      leaderboard.push({
        name: localStorage.getItem("userName"),
        dob: localStorage.getItem("userDob"),
        marks: marks,
        percentage: percentage
      });
      localStorage.setItem("leaderboard", JSON.stringify(leaderboard));

      alert(`Test Submitted!\nCorrect: ${correct}\nWrong: ${wrong}\nUnattempted: ${unattempted}\nMarks: ${marks}\nPercentage: ${percentage}%`);
      submitBtn.style.display = "none";
      leaderboardBtn.style.display = "block";
      closeBtn.style.display = "block";
    });

    leaderboardBtn.addEventListener("click", () => {
      window.location.href = "leaderboard.html";
    });

    closeBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
